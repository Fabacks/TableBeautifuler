/**
 * TableBeautifuller
 * 
 * Author: Fabacks
 * License: Free distribution except for commercial use
 * GitHub Repository: https://github.com/Fabacks/TableBeautifuller
 * Version 1.0.1
 * 
 * This software is provided "as is" without any warranty. The author is
 * not responsible for any damages or liabilities caused by the use of this software.
 * Please do not use this software for commercial purposes without explicit permission from the author.
 * If you use or distribute this software, please credit the author and link back to the GitHub repository.
 */

class TableBeautifuller{constructor(t,e={}){this.table=document.querySelector(t),this.eventList=[],this.plugins=[],this.filters={},this.options={},this.displayBloc={},this.lang=e.language??"en_EN",this.translation=e.translation??null,this.displayBloc.info=e.info??!0,this.displayBloc.ordering=e.ordering??!0,this.displayBloc.paging=e.paging??!0,this.displayBloc.searching=e.searching??!0,this.displayBloc.columnSearch=e.columnSearch??!0,this.options.temperature=parseInt(e.temperature)||1;let a=e.order||this.table.getAttribute("data-order");"string"==typeof a?this.initialOrder=JSON.parse(a):Array.isArray(a)?this.initialOrder=a:this.initialOrder=[],this.pageLength=e.pageLength||parseInt(this.table.getAttribute("data-page-length"))||10,this.currentPage=1,this.selectItemPage=e.selectItemPage||[10,20,30],this.selectItemPage.includes(this.pageLength)||(this.selectItemPage.push(this.pageLength),this.selectItemPage.sort(((t,e)=>t-e))),this.debounce_delai=e.debounceDelai||300,this.options.rowOddEven=e.rowOddEven??!0,this.init()}init(){null===this.translation&&this.loadTranslate(),this.createWrappers(),this.displayBloc.searching&&this.addSearchInput(),this.displayBloc.ordering&&(this.addSortingArrows(),this.applyInitialOrder()),this.displayBloc.columnSearch&&this.addSearchColumn(),this.displayBloc.info&&this.addInfoControls(),this.displayBloc.paging&&(this.addPaginationControls(),this.paginate())}ready(){return this.readyPromise}loadTranslate(){if("en_EN"!==this.lang)try{let t=new XMLHttpRequest;if(t.open("GET",this.lang,!1),t.setRequestHeader("Content-Type","application/json"),t.send(null),200!==t.status)throw new Error(`HTTP error! status: ${response.status}`);this.translation=JSON.parse(t.responseText)}catch(t){console.error("Error loading translation file :",t)}else this.getLangDefault()}translator(t,e={}){let a=this.translation[t]||t;for(let[t,i]of Object.entries(e))a=a.replace(`{{${t}}}`,i);return a}getLangDefault(){this.translation={searchGlobalTitle:"Search in global table",searchGlobalPlaceholder:"Search...",searchColomnTitle:"Search in the column : ",searchColomnPlaceholder:"Search in the column ...",infoLabel:"Display of {{start}} element at {{end}} on {{total}} elements",previous:"Previous",next:"Next",all:"All",selectItemsDisplay:"Display",selectItemsItems:"items",selectItemsTitle:"List for numbers items display",copy:"Copy",copyTitle:"Copy to clipboard",copyExported:"Text copied to clipboard",csv:"CSV",csvTitle:"Export to CSV"}}use(t){t.install(this),this.plugins.push(t)}createWrappers(){this.table.classList.add("tableBeautifuller"),this.paginationWrapperTopContainer=document.createElement("div"),this.paginationWrapperTopContainer.classList.add("tableBeautifuller","pagination-wrapper-top-container"),this.table.parentNode.insertBefore(this.paginationWrapperTopContainer,this.table),this.paginationWrapperDownContainer=document.createElement("div"),this.paginationWrapperDownContainer.classList.add("tableBeautifuller","pagination-down-container"),this.table.parentNode.appendChild(this.paginationWrapperDownContainer)}debounce(t,e){let a;return function(){const i=this,n=arguments;clearTimeout(a),a=setTimeout((()=>t.apply(i,n)),e)}}addEventList(t,e,a){t.addEventListener(e,a),this.eventList.push({element:t,eventName:e,listener:a})}addSearchInput(){this.searchInput=document.createElement("input"),this.searchInput.title=this.translator("searchGlobalTitle"),this.searchInput.setAttribute("type","text"),this.searchInput.setAttribute("placeholder",this.translator("searchGlobalPlaceholder")),this.searchInput.className="search-input",this.paginationWrapperTopContainer.appendChild(this.searchInput),this.addEventList(this.searchInput,"keyup",this.debounce((()=>{this.searchTable(null,this.searchInput.value)}),this.debounce_delai).bind(this))}addSearchColumn(){let t=document.createElement("tr");t.classList.add("thead-search"),this.table.querySelectorAll("th").forEach((e=>{let a=document.createElement("th"),i=e.getAttribute("data-search")??"",n=this.translator("searchColomnTitle")+e.innerHTML.indexOf("<span")!==-1?e.innerHTML.substring(0,e.innerHTML.indexOf("<span")).trim():e.innerText;switch(i){case"input":let t=document.createElement("input");t.type="text",t.title=n,t.placeholder=this.translator("searchColomnPlaceholder"),this.addEventList(t,"input",this.debounce((t=>{this.searchTable(e.cellIndex,t.target.value)}),this.debounce_delai).bind(this)),a.appendChild(t);break;case"combobox":let i=document.createElement("select");i.title=n;let s=this.getUniqueValuesForColumn(e.cellIndex);i.innerHTML='<option value="">'+this.translator("all")+"</option>",s.forEach((t=>{let e=document.createElement("option");e.value=t,e.textContent=t,i.appendChild(e)})),this.addEventList(i,"change",this.debounce((t=>{this.searchTable(e.cellIndex,t.target.value)}),this.debounce_delai).bind(this)),a.appendChild(i);break;default:return}t.appendChild(a)})),this.table.querySelector("thead").appendChild(t)}getUniqueValuesForColumn(t){let e=[];return this.table.querySelector("tbody").querySelectorAll("tr").forEach((a=>{let i=a.cells[t],n=i.hasAttribute("data-search")?i.getAttribute("data-search"):i.textContent.trim();e.includes(n)||e.push(n)})),e}addSortingArrows(){this.table.querySelectorAll("th").forEach(((t,e)=>{t.dataset.sort="none";let a=document.createElement("span");a.classList.add("sort-arrow"),t.appendChild(a),this.addEventList(t,"click",this.headerClickHandler.bind(this,t,e))}))}headerClickHandler(t,e){let a="asc"===t.dataset.sort?"desc":"asc";this.sortTable(e,a),t.dataset.sort=a,this.updateArrows(t)}updateArrows(t){this.table.querySelectorAll(".sort-arrow").forEach((t=>{t.textContent=""})),t.querySelector(".sort-arrow").textContent="asc"===t.dataset.sort?"▲":"▼"}detectColumnType(t){let e=this.table.querySelector("tbody").querySelectorAll("tr");for(let a=0;a<e.length;a++)if(e[a].cells[t]){let i=e[a].cells[t].hasAttribute("data-order")?e[a].cells[t].getAttribute("data-order"):e[a].cells[t].textContent.trim();if(!isNaN(i))return"number"}return"string"}sortTable(t,e){let a=this.detectColumnType(t),i=Array.from(this.table.querySelector("tbody").querySelectorAll("tr"));i.sort(((i,n)=>{let s=i.cells[t].hasAttribute("data-order")?i.cells[t].getAttribute("data-order"):i.cells[t].textContent.trim(),r=n.cells[t].hasAttribute("data-order")?n.cells[t].getAttribute("data-order"):n.cells[t].textContent.trim();return"number"===a?"asc"===e?s-r:r-s:"asc"===e?s.localeCompare(r):r.localeCompare(s)})),this.table.querySelector("tbody").append(...i),this.oddEven()}applyInitialOrder(){this.initialOrder.forEach((t=>{let[e,a]=t;this.sortTable(e,a.toLowerCase());let i=this.table.querySelector(`th:nth-child(${e+1})`);i.dataset.sort=a.toLowerCase(),this.updateArrows(i)}))}oddEven(){if(!this.options.rowOddEven)return;let t=this.table.querySelectorAll("tbody tr");var e=0;t.forEach((t=>{"none"!=t.style.display&&(e++,t.classList.remove("even"),t.classList.remove("odd"),e%2==0?t.classList.add("even"):t.classList.add("odd"))}))}searchTable(t,e){let a=null==t?"global":t;""!=(e=e.trim()).trim()?this.filters[a]=e.toLowerCase():delete this.filters[a];let i=this.table.querySelectorAll("tbody tr");i.forEach((t=>{t.dataset.matched="true",t.style.display=""})),i.forEach((t=>{for(const[e,a]of Object.entries(this.filters)){if("true"!==t.dataset.matched)return;let i="";if("global"!==e){let a=t.cells[parseInt(e)];i=a.hasAttribute("data-search")?a.getAttribute("data-search"):a.textContent}else{let e=Array.from(t.getElementsByTagName("td"));i=Array.from(e).map((t=>t.hasAttribute("data-search")?t.getAttribute("data-search"):t.textContent)).join(" ")}i=i.trim().toLowerCase(),this.matchesUsingLevenshtein(i,a)||(t.style.display="none",t.dataset.matched="false")}})),this.currentPage=1,this.paginate()}matchesUsingLevenshtein(t,e){if(-1!==t.indexOf(e))return!0;if(0==this.options.temperature||e.length<4||"string"!=typeof t||"string"!=typeof e)return!1;for(let a=0;a<=t.length-e.length;a++){let i=t.substring(a,a+e.length);if(this.levenshteinDistance(i,e)<=this.options.temperature)return!0}return!1}levenshteinDistance(t,e){const a=[];let i,n;for(i=0;i<=e.length;i++)a[i]=[i];for(n=0;n<=t.length;n++)a[0][n]=n;for(i=1;i<=e.length;i++)for(n=1;n<=t.length;n++)e.charAt(i-1)===t.charAt(n-1)?a[i][n]=a[i-1][n-1]:a[i][n]=Math.min(a[i-1][n-1]+1,a[i][n-1]+1,a[i-1][n]+1);return a[e.length][t.length]}paginate(){let t=Array.from(this.table.querySelectorAll("tbody tr")).filter((t=>"false"!==t.dataset.matched)).length,e=Math.ceil(t/this.pageLength),a=(this.currentPage-1)*this.pageLength,i=a+this.pageLength;if(this.displayBloc.info){let e=i>t?t:i;this.infoLabel.textContent=this.translator("infoLabel",{start:a,end:e,total:t})}this.prevButton.disabled=this.currentPage<=1,this.nextButton.disabled=this.currentPage>=e,Array.from(this.table.querySelectorAll("tbody tr")).filter((t=>"false"!==t.dataset.matched)).forEach(((t,e)=>{t.style.display=e<a||e>=i?"none":""})),this.paginationButtonsContainer.querySelectorAll(".page-btn").forEach((t=>{this.paginationButtonsContainer.removeChild(t)}));let n=Math.max(1,this.currentPage-3),s=Math.min(e,this.currentPage+3)-1,r=this.paginationButtonsContainer.lastElementChild;for(let t=n-1;t<=s;t++){let e=n+t,a=document.createElement("button");a.textContent=e,a.setAttribute("data-page",e),a.className="page-btn",a.classList.toggle("active",e===this.currentPage),this.paginationButtonsContainer.insertBefore(a,r)}this.oddEven()}addInfoControls(){this.infoLabel=document.createElement("span"),this.infoLabel.className="pagination-info",this.paginationWrapperDownContainer.appendChild(this.infoLabel)}addPaginationControls(){this.paginationWrapperTop=document.createElement("div"),this.paginationWrapperTop.className="pagination-wrapper-top",this.paginationInfoTop=document.createElement("span"),this.paginationInfoTop.textContent=this.translator("selectItemsDisplay"),this.paginationWrapperTop.appendChild(this.paginationInfoTop),this.paginationSelect=document.createElement("select"),this.paginationSelect.title=this.translator("selectItemsTitle"),this.selectItemPage.forEach((t=>{let e=document.createElement("option");e.value=t,e.textContent=t,e.selected=t===this.pageLength,this.paginationSelect.appendChild(e)})),this.paginationSelect.value=this.pageLength,this.paginationWrapperTop.appendChild(this.paginationSelect),this.paginationInfoTopAfter=document.createElement("span"),this.paginationInfoTopAfter.textContent=this.translator("selectItemsItems"),this.paginationWrapperTop.appendChild(this.paginationInfoTopAfter),this.paginationWrapperTopContainer.appendChild(this.paginationWrapperTop),this.paginationButtonsContainer=document.createElement("div"),this.paginationButtonsContainer.className="pagination-buttons-container",this.prevButton=document.createElement("button"),this.prevButton.textContent=this.translator("previous"),this.prevButton.className="page-prev",this.paginationButtonsContainer.appendChild(this.prevButton),this.nextButton=document.createElement("button"),this.nextButton.textContent=this.translator("next"),this.nextButton.className="page-next",this.paginationButtonsContainer.appendChild(this.nextButton),this.paginationWrapperDownContainer.appendChild(this.paginationButtonsContainer),this.addEventList(this.paginationSelect,"change",(()=>{this.pageLength=parseInt(this.paginationSelect.value),this.currentPage=1,this.paginate()}).bind(this)),this.addEventList(this.paginationButtonsContainer,"click",(t=>{let e=t.target.classList;e.contains("page-btn")?this.currentPage=parseInt(t.target.getAttribute("data-page")):e.contains("page-prev")?this.currentPage--:e.contains("page-next")&&this.currentPage++,this.paginate()}).bind(this))}destroy(){this.eventList.forEach((({element:t,eventName:e,listener:a})=>{t.removeEventListener(e,a)})),this.table.querySelectorAll("th").forEach((t=>{let e=t.querySelector(".sort-arrow");e&&e.remove()})),this.table.querySelectorAll("tbody tr").forEach((t=>{t.style.display=""})),this.paginationWrapperTopContainer&&this.paginationWrapperTopContainer.remove(),this.paginationWrapperDownContainer&&this.paginationWrapperDownContainer.remove();let t=this.table.querySelector(".thead-search");t&&t.remove();for(let t in this)this.hasOwnProperty(t)&&(this[t]=null)}}