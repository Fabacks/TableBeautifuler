/**
 * TableBeautifuller
 * 
 * Author: Fabacks
 * License: Free distribution except for commercial use
 * GitHub Repository: https://github.com/Fabacks/TableBeautifuller
 * Version 1.0.4
 * 
 * This software is provided "as is" without any warranty. The author is
 * not responsible for any damages or liabilities caused by the use of this software.
 * Please do not use this software for commercial purposes without explicit permission from the author.
 * If you use or distribute this software, please credit the author and link back to the GitHub repository.
 */

class TableBeautifuller{constructor(t,e={}){this.table=document.querySelector(t),this.eventList=[],this.plugins=[],this.filters={},this.options={},this.displayBloc={},this.langDefault="en_EN",this.lang=e.language??this.langDefault,this.translation=e.translation??null,this.displayBloc.info=e.info??!0,this.displayBloc.ordering=e.ordering??!0,this.displayBloc.paging=e.paging??!0,this.displayBloc.searching=e.searching??!0,this.displayBloc.columnSearch=e.columnSearch??!0,this.options.temperature=parseInt(e.temperature)||1,this.options.searchType=e.searchType??"levenshtein",this.options.searchChooses={};let a=e.order||this.table.getAttribute("data-order");"string"==typeof a?this.sortedColumns=JSON.parse(a):Array.isArray(a)?this.sortedColumns=a:this.sortedColumns=[],this.pageLength=e.pageLength||parseInt(this.table.getAttribute("data-page-length"))||10,this.currentPage=1,this.selectItemPage=e.selectItemPage||[10,20,30,40,50],this.selectItemPage.includes(this.pageLength)||(this.selectItemPage.push(this.pageLength),this.selectItemPage.sort(((t,e)=>t-e))),this.debounce_delai=e.debounceDelai||300,this.options.rowOddEven=e.rowOddEven??!0,this.init()}init(){this.loadTranslate(),this.options.searchChooses=[{section:this.translator("searchOfType"),options:[{key:"strict",label:this.translator("searchDropStrict")},{key:"levenshtein",label:this.translator("searchDropLevenshtein")},{key:"regex",label:this.translator("searchDropRegex")}]}],this.createWrappers(),this.displayBloc.searching&&this.addSearchInput(),this.displayBloc.info&&this.addInfoControls(),this.displayBloc.paging&&this.addPaginationControls(),this.displayBloc.ordering&&(this.addSortingArrows(),this.applyInitialOrder()),this.displayBloc.ordering||this.paginate(),this.displayBloc.columnSearch&&this.addSearchColumn()}ready(){return this.readyPromise}loadTranslate(){if(null===this.translation)if(this.lang!==this.langDefault)try{let t=new XMLHttpRequest;if(t.open("GET",this.lang,!1),t.setRequestHeader("Content-Type","application/json"),t.send(null),200!==t.status)throw new Error(`HTTP error! status: ${response.status}`);this.translation=JSON.parse(t.responseText)}catch(t){}else this.getLangDefault()}translator(t,e={}){let a=this.translation[t]||t;for(let[t,n]of Object.entries(e))a=a.replace(`{{${t}}}`,n);return a}getLangDefault(){this.translation={searchGlobalTitle:"Search in global table",searchGlobalPlaceholder:"Search...",searchColomnTitle:"Search in the column : ",searchColomnPlaceholder:"Search in the column ...",infoLabel:"Display of {{start}} element at {{end}} on {{total}} elements",previous:"Previous",next:"Next",all:"All",selectItemsDisplay:"Display",selectItemsItems:"items",selectItemsTitle:"List for numbers items display",copy:"Copy",copyTitle:"Copy to clipboard",copyExported:"Text copied to clipboard",csv:"CSV",csvTitle:"Export to CSV",searchOfType:"Type of search",searchDropStrict:"Strict",searchDropRegex:"Regex",searchDropLevenshtein:"Levenshtein",searchDropCompose:"Compose"}}use(t){t.install(this),this.plugins.push(t)}createWrappers(){this.table.classList.add("tableBeautifuller"),this.paginationWrapperTopContainer=document.createElement("div"),this.paginationWrapperTopContainer.classList.add("tableBeautifuller","pagination-wrapper-top-container"),this.table.parentNode.insertBefore(this.paginationWrapperTopContainer,this.table),this.paginationWrapperDownContainer=document.createElement("div"),this.paginationWrapperDownContainer.classList.add("tableBeautifuller","pagination-down-container"),this.table.parentNode.appendChild(this.paginationWrapperDownContainer)}debounce(t,e){let a;return function(){const n=this,s=arguments;clearTimeout(a),a=setTimeout((()=>t.apply(n,s)),e)}}addEventList(t,e,a){t.addEventListener(e,a),this.eventList.push({element:t,eventName:e,listener:a})}addSearchInput(){let t=this.addSearchDropdownContent();this.paginationWrapperTopContainer.appendChild(t),this.searchInput=document.createElement("input"),this.searchInput.title=this.translator("searchGlobalTitle"),this.searchInput.setAttribute("type","text"),this.searchInput.setAttribute("placeholder",this.translator("searchGlobalPlaceholder")),this.searchInput.className="search-input",this.paginationWrapperTopContainer.appendChild(this.searchInput),this.addEventList(this.searchInput,"keyup",this.debounce((()=>{this.handleSearchTable(null,this.searchInput.value,"text")}),this.debounce_delai).bind(this))}addSearchColumn(){let t=document.createElement("tr");t.classList.add("thead-search");let e=this.table.querySelectorAll("thead th"),a=!1;for(const t of e){if(""!==(t.getAttribute("data-search")??"")){a=!0;break}}a&&(e.forEach((e=>{let a=document.createElement("th"),n=e.getAttribute("data-search")??"",s=this.translator("searchColomnTitle")+e.innerHTML.indexOf("<span")!==-1?e.innerHTML.substring(0,e.innerHTML.indexOf("<span")).trim():e.innerText;switch(n){case"input":case"text":let t=document.createElement("input");t.type="text",t.title=s,t.placeholder=this.translator("searchColomnPlaceholder"),this.addEventList(t,"input",this.debounce((t=>{this.handleSearchTable(e.cellIndex,t.target.value,"text")}),this.debounce_delai).bind(this)),a.appendChild(t);break;case"combobox":case"select":let n=e.getAttribute("data-searchOrder")??"asc";n=n.toLowerCase(),"asc"!==n&&"desc"!==n&&(n="asc");let i=document.createElement("select");i.title=s;let r=this.getUniqueValuesForColumn(e.cellIndex,n);i.innerHTML='<option value="">'+this.translator("all")+"</option>",r.forEach((t=>{let e=document.createElement("option");e.value=t,e.textContent=t,i.appendChild(e)})),this.addEventList(i,"change",(t=>{this.handleSearchTable(e.cellIndex,t.target.value,"select")})),a.appendChild(i)}t.appendChild(a)})),this.table.querySelector("thead").appendChild(t))}addSearchDropdownContent(){let t=document.createElement("div");t.classList.add("wrapper-dropdown");let e=document.createElement("button");e.id="search-options-button",e.innerHTML="&#8942",e.addEventListener("click",(()=>this.toggleSearchDropdown())),t.appendChild(e);let a=document.createElement("div");return a.id="search-dropdown",a.classList.add("dropdown"),this.options.searchChooses.forEach((t=>{let e=document.createElement("div");e.classList.add("dropdown-wrapper_items"),a.appendChild(e);let n=document.createElement("div");n.classList.add("dropdown-header"),n.textContent=t.section,e.appendChild(n),t.options.forEach((t=>{let a=document.createElement("div");a.classList.add("dropdown-item"),a.setAttribute("data-key",t.key),t.key===this.options.searchType&&a.classList.add("selected");let n=document.createElement("span");n.classList.add("check-icon"),n.textContent="✔",a.appendChild(n);let s=document.createElement("span");s.textContent=t.label,a.appendChild(s),a.addEventListener("click",(()=>this.handleOptionSearchDropdownClick(a))),e.appendChild(a)}))})),t.appendChild(a),document.addEventListener("click",(e=>this.handleOutsideSearchDropdownClick(e,t))),t}toggleSearchDropdown(){let t=document.querySelector("#search-dropdown");t.style.display="block"===t.style.display?"none":"block"}handleOptionSearchDropdownClick(t){let e=t.getAttribute("data-key");this.options.searchType=e,document.querySelectorAll(".dropdown-item").forEach((t=>{t.classList.remove("selected")})),t.classList.add("selected"),this.searchTable("text")}handleOutsideSearchDropdownClick(t,e){if(!e.contains(t.target)){document.querySelector("#search-dropdown").style.display="none"}}getUniqueValuesForColumn(t,e){let a=[];return this.table.querySelector("tbody").querySelectorAll("tr").forEach((e=>{let n=e.cells[t],s=n.hasAttribute("data-search")?n.getAttribute("data-search"):n.textContent.trim();a.includes(s)||a.push(s)})),a.sort(((t,a)=>{let n=isNaN(t)?t:parseFloat(t),s=isNaN(a)?a:parseFloat(a);return n<s?"asc"===e?-1:1:n>s?"asc"===e?1:-1:0})),a}addSortingArrows(){this.table.querySelectorAll("th").forEach(((t,e)=>{t.dataset.sort="none";let a=document.createElement("span");a.classList.add("sort-arrow"),t.appendChild(a),this.addEventList(t,"click",this.headerClickHandler.bind(this,t,e))}))}headerClickHandler(t,e){let a="asc"===t.dataset.sort?"desc":"asc";t.dataset.sort=a,this.sortTable(e,a),this.updateArrows(t)}updateArrows(t){this.table.querySelectorAll(".sort-arrow").forEach((t=>{t.textContent=""})),t.querySelector(".sort-arrow").textContent="asc"===t.dataset.sort?"▲":"▼"}detectColumnType(t){let e=this.table.querySelector("tbody").querySelectorAll("tr");for(let a=0;a<e.length;a++)if(e[a].cells[t]){let n=e[a].cells[t].hasAttribute("data-order")?e[a].cells[t].getAttribute("data-order"):e[a].cells[t].textContent.trim();if(!isNaN(n))return"number"}return"string"}sortTable(t,e){let a=Array.from(this.table.querySelector("tbody").querySelectorAll("tr"));a.sort(((a,n)=>{let s=a.cells[t].hasAttribute("data-order")?a.cells[t].getAttribute("data-order"):a.cells[t].textContent.trim(),i=n.cells[t].hasAttribute("data-order")?n.cells[t].getAttribute("data-order"):n.cells[t].textContent.trim();return"number"===this.detectColumnType(t)?"asc"===e?s-i:i-s:"asc"===e?s.localeCompare(i):i.localeCompare(s)})),this.table.querySelector("tbody").append(...a),this.displayBloc.paging?this.paginate():this.oddEven()}applyInitialOrder(){this.sortedColumns.forEach((t=>{let[e,a]=t;this.sortTable(e,a.toLowerCase());let n=this.table.querySelector(`th:nth-child(${e+1})`);n.dataset.sort=a.toLowerCase(),this.updateArrows(n)}))}oddEven(){if(!this.options.rowOddEven)return;let t=this.table.querySelectorAll("tbody tr");var e=0;t.forEach((t=>{"none"!=t.style.display&&(e++,t.classList.remove("even"),t.classList.remove("odd"),e%2==0?t.classList.add("even"):t.classList.add("odd"))}))}handleSearchTable(t,e,a){let n=null==t?"global":t;""!=(e=e.trim()).trim()?this.filters[n]=e.toLowerCase():delete this.filters[n],this.searchTable(a)}searchTable(t,e=null){let a=this.table.querySelectorAll("tbody tr");a.forEach((t=>{t.dataset.matched="true",t.style.display=""})),a.forEach((a=>{if("true"===a.dataset.matched)for(const[n,s]of Object.entries(this.filters)){const i=this.extractRowText(a,n);let r=!1;switch(null==e?this.options.searchType:"levenshtein"){case"special":r=this.matchesSpecial(i,s);break;case"regex":r=this.matchesRegex(i,s);break;case"levenshtein":r=this.matchesUsingLevenshtein(i,s,t);break;case"strict":r=this.matchesUsingLevenshtein(i,s,t,0)}r||(a.style.display="none",a.dataset.matched="false")}})),this.currentPage=1,this.paginate()}matchesSpecial(t,e){const a=e.split(/\s+/);let n=[],s=[],i=[];a.forEach((t=>{t.startsWith("+")?n.push(t.substring(1).replace(/\*/g,".*")):t.startsWith("-")?s.push(t.substring(1).replace(/\*/g,".*")):t.endsWith("%")?i.push(t.slice(0,-1)):n.push(t.replace(/\*/g,".*"))}));for(let e of n){if(!new RegExp(e).test(t))return!1}for(let e of s){if(new RegExp(e).test(t))return!1}for(let e of i)if(this.levenshteinDistance(t,e)>this.options.temperature)return!1;return!0}matchesRegex(t,e){return new RegExp(e,"i").test(t)}extractRowText(t,e){let a="";if("global"!==e){let n=t.cells[parseInt(e)];a=n.hasAttribute("data-search")?n.getAttribute("data-search"):n.textContent}else{a=Array.from(t.getElementsByTagName("td")).map((t=>t.hasAttribute("data-search")?t.getAttribute("data-search"):t.textContent)).join(" ")}return a.trim().toLowerCase()}determineTemperature(t){let e=0;if("text"===t)e=this.options.temperature;else e=0;return e}matchesUsingLevenshtein(t,e,a,n=null){if(-1!==t.indexOf(e))return!0;const s=n??this.determineTemperature(a);if(0==s||e.length<4||"string"!=typeof t||"string"!=typeof e)return!1;for(let a=0;a<=t.length-e.length;a++){let n=t.substring(a,a+e.length);if(this.levenshteinDistance(n,e)<=s)return!0}return!1}levenshteinDistance(t,e){const a=[];let n,s;for(n=0;n<=e.length;n++)a[n]=[n];for(s=0;s<=t.length;s++)a[0][s]=s;for(n=1;n<=e.length;n++)for(s=1;s<=t.length;s++)e.charAt(n-1)===t.charAt(s-1)?a[n][s]=a[n-1][s-1]:a[n][s]=Math.min(a[n-1][s-1]+1,a[n][s-1]+1,a[n-1][s]+1);return a[e.length][t.length]}paginate(){let t=Array.from(this.table.querySelectorAll("tbody tr")).filter((t=>"false"!==t.dataset.matched)).length,e=Math.ceil(t/this.pageLength),a=(this.currentPage-1)*this.pageLength,n=a+this.pageLength;if(this.displayBloc.info){let e=n>t?t:n;this.infoLabel.textContent=this.translator("infoLabel",{start:a,end:e,total:t})}this.prevButton.disabled=this.currentPage<=1,this.nextButton.disabled=this.currentPage>=e,Array.from(this.table.querySelectorAll("tbody tr")).filter((t=>"false"!==t.dataset.matched)).forEach(((t,e)=>{t.style.display=e<a||e>=n?"none":""})),this.paginationButtonsContainer.querySelectorAll(".page-btn").forEach((t=>{this.paginationButtonsContainer.removeChild(t)}));let s=Math.max(1,this.currentPage-1),i=Math.min(e,this.currentPage+1),r=this.paginationButtonsContainer.lastElementChild;s>1&&this.addPageButton(1,r);for(let t=s;t<=i;t++)this.addPageButton(t,r);i<e&&this.addPageButton(e,r),this.oddEven()}addPageButton(t,e){let a=document.createElement("button");a.textContent=t,a.setAttribute("data-page",t),a.className="page-btn",a.classList.toggle("active",t===this.currentPage),this.paginationButtonsContainer.insertBefore(a,e)}addInfoControls(){this.infoLabel=document.createElement("span"),this.infoLabel.className="pagination-info",this.paginationWrapperDownContainer.appendChild(this.infoLabel)}addPaginationControls(){this.paginationWrapperTop=document.createElement("div"),this.paginationWrapperTop.className="pagination-wrapper-top",this.paginationInfoTop=document.createElement("span"),this.paginationInfoTop.textContent=this.translator("selectItemsDisplay"),this.paginationWrapperTop.appendChild(this.paginationInfoTop),this.paginationSelect=document.createElement("select"),this.paginationSelect.title=this.translator("selectItemsTitle"),this.selectItemPage.forEach((t=>{let e=document.createElement("option");e.value=t,e.textContent=t,e.selected=t===this.pageLength,this.paginationSelect.appendChild(e)})),this.paginationSelect.value=this.pageLength,this.paginationWrapperTop.appendChild(this.paginationSelect),this.paginationInfoTopAfter=document.createElement("span"),this.paginationInfoTopAfter.textContent=this.translator("selectItemsItems"),this.paginationWrapperTop.appendChild(this.paginationInfoTopAfter),this.paginationWrapperTopContainer.appendChild(this.paginationWrapperTop),this.paginationButtonsContainer=document.createElement("div"),this.paginationButtonsContainer.className="pagination-buttons-container",this.prevButton=document.createElement("button"),this.prevButton.textContent=this.translator("previous"),this.prevButton.className="page-prev",this.paginationButtonsContainer.appendChild(this.prevButton),this.nextButton=document.createElement("button"),this.nextButton.textContent=this.translator("next"),this.nextButton.className="page-next",this.paginationButtonsContainer.appendChild(this.nextButton),this.paginationWrapperDownContainer.appendChild(this.paginationButtonsContainer),this.addEventList(this.paginationSelect,"change",(()=>{this.pageLength=parseInt(this.paginationSelect.value),this.currentPage=1,this.paginate()}).bind(this)),this.addEventList(this.paginationButtonsContainer,"click",(t=>{let e=t.target.classList;e.contains("page-btn")?this.currentPage=parseInt(t.target.getAttribute("data-page")):e.contains("page-prev")?this.currentPage--:e.contains("page-next")&&this.currentPage++,this.paginate()}).bind(this))}destroy(){this.eventList.forEach((({element:t,eventName:e,listener:a})=>{t.removeEventListener(e,a)})),this.table.querySelectorAll("th").forEach((t=>{let e=t.querySelector(".sort-arrow");e&&e.remove()})),this.table.querySelectorAll("tbody tr").forEach((t=>{t.style.display=""})),this.paginationWrapperTopContainer&&this.paginationWrapperTopContainer.remove(),this.paginationWrapperDownContainer&&this.paginationWrapperDownContainer.remove();let t=this.table.querySelector(".thead-search");t&&t.remove();for(let t in this)this.hasOwnProperty(t)&&(this[t]=null)}}"object"==typeof exports&&"undefined"!=typeof module?module.exports=TableBeautifuller:window.TableBeautifuller=TableBeautifuller;